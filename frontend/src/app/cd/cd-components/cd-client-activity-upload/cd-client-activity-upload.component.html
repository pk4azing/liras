<div class="card mt-2" *ngIf="!isGenerated">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h3 class="card-title mb-0">Create Report</h3>
  </div>

  <form class="card-body collapse show" id="reportFormCollapse" [formGroup]="reportForm" (ngSubmit)="onSubmit()">

    <!-- Config File Upload -->
    <div class="mb-4 row align-items-start">
      <label class="col-md-3 col-form-label">Upload Config File <span class="text-danger">*</span></label>
      <div class="col-md-9" appCdModeDirective>
        <div class="position-relative file-upload-wrapper">
          <input #configFileInput type="file"
            class="form-control position-absolute top-0 start-0 opacity-0 file-upload-input" id="config_files" multiple
            accept=".config,.conf,.ini,.json" (change)="onConfigFileBrowse($event)" formControlName="configFiles"
            style="z-index: 2; height: 100%; cursor: pointer;" />

          <div class="form-control bg-light text-muted file-upload-display pointer-events-none filenameclass"
            style="z-index: 1;">
            {{ uploadedConfigFiles.length > 0
            ? (uploadedConfigFiles.length + (uploadedConfigFiles.length === 1 ? ' file selected' : ' files selected'))
            : 'Click to select config files' }}
          </div>
        </div>

        <div class="mt-2 text-danger small"
          *ngIf="reportForm.get('configFiles')?.hasError('required') && reportForm.get('configFiles')?.touched">
          Please select at least one config file
        </div>

        <!-- File List -->
        <div class="mt-3" *ngIf="uploadedConfigFiles.length > 0">
          <div *ngFor="let file of uploadedConfigFiles; let i = index"
            class="bg-light border rounded p-3 mb-3 shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-truncate small fw-medium text-dark" style="max-width: 300px;">{{ file.FileName }}</span>
              <button type="button" (click)="removeConfigFile(i)" class="btn btn-link text-danger p-0 small">
                <i class="bi bi-x-circle me-1"></i> Remove
              </button>
            </div>
            <div class="progress mb-1" style="height: 6px;">
              <div class="progress-bar bg-success" role="progressbar" [style.width.%]="file.FileProgress"></div>
            </div>
            <div class="d-flex justify-content-between small text-muted">
              <span>{{ file.FileProgessSize }} of {{ file.FileSize }}</span>
              <span>{{ file.FileProgress }}%</span>
            </div>
            <div class="text-end mt-1">
              <span class="small"
                [ngClass]="{ 'text-success': file.FileProgress === 100, 'text-warning': file.FileProgress < 100 }">
                {{ file.FileProgress === 100 ? 'Ready to generate' : 'Uploading...' }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Text File Upload -->
    <div class="mb-4 row align-items-start">
      <label class="col-md-3 col-form-label">Upload TXT File <span class="text-danger">*</span></label>
      <div class="col-md-9" appCdModeDirective>
        <div class="position-relative file-upload-wrapper">
          <input #textFileInput type="file"
            class="form-control position-absolute top-0 start-0 opacity-0 file-upload-input" id="text_files" multiple
            accept=".txt" (change)="onTextFileBrowse($event)" formControlName="textFiles"
            style="z-index: 2; height: 100%; cursor: pointer;" />

          <div class="form-control bg-light text-muted file-upload-display pointer-events-none filenameclass"
            style="z-index: 1;">
            {{ uploadedTextFiles.length > 0
            ? (uploadedTextFiles.length + (uploadedTextFiles.length === 1 ? ' file selected' : ' files selected'))
            : 'Click to select text files' }}
          </div>
        </div>


        <div class="mt-2 text-danger small"
          *ngIf="reportForm.get('textFiles')?.hasError('required') && reportForm.get('textFiles')?.touched">
          Please select at least one text file
        </div>

        <!-- File List -->
        <div class="mt-3" *ngIf="uploadedTextFiles.length > 0">
          <div *ngFor="let file of uploadedTextFiles; let i = index" class="bg-light border rounded p-3 mb-3 shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-truncate small fw-medium text-dark" style="max-width: 300px;">{{ file.FileName }}</span>
              <button type="button" (click)="removeTextFile(i)" class="btn btn-link text-danger p-0 small">
                <i class="bi bi-x-circle me-1"></i> Remove
              </button>
            </div>
            <div class="progress mb-1" style="height: 6px;">
              <div class="progress-bar bg-success" role="progressbar" [style.width.%]="file.FileProgress"></div>
            </div>
            <div class="d-flex justify-content-between small text-muted">
              <span>{{ file.FileProgessSize }} of {{ file.FileSize }}</span>
              <span>{{ file.FileProgress }}%</span>
            </div>
            <div class="text-end mt-1">
              <span class="small"
                [ngClass]="{ 'text-success': file.FileProgress === 100, 'text-warning': file.FileProgress < 100 }">
                {{ file.FileProgress === 100 ? 'Ready to generate' : 'Uploading...' }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="row">
      <label class="col-md-3 col-form-label"></label>
      <div class="col-md-9 text-end">
        <button type="submit" class="btn btn-primary me-2" [disabled]="!reportForm.valid">Generate Report</button>
        <button type="button" class="btn btn-outline-secondary" (click)="resetForm()">Cancel</button>
      </div>
    </div>
  </form>

</div>

<div *ngIf="isGenerated" class="mt-4">
  <div appCdModeDirective>
    <!-- INI Section -->
    <h5 class="headclass d-flex justify-content-between align-items-center">
      INI File Preview
      <button class="btn btn-link p-0 border-0" (click)="editINI = true" *ngIf="!editINI">
        <i class="fa fa-edit text-primary"></i>
      </button>
    </h5>

    <div class="ddiv">
      <pre *ngIf="!editINI" class="bg-light p-3 border rounded mb-2">{{ configFilePreview }}</pre>

      <textarea *ngIf="editINI" [(ngModel)]="configFilePreview" class="form-control mb-2" rows="10"></textarea>
      <div *ngIf="editINI" class="d-flex justify-content-end">
        <button class="btn btn-secondary me-2" (click)="cancelEdit('ini')">Cancel</button>
        <button class="btn btn-primary" [disabled]="!isValidINI(configFilePreview)" (click)="saveINI()">Save</button>
      </div>
    </div>

    <!-- Text Section -->
    <h5 class="headclass mt-3 d-flex justify-content-between align-items-center">
      Text File Summary
      <i class="fa fa-edit text-primary cursor-pointer" (click)="editText = true" *ngIf="!editText"></i>
    </h5>

    <div class="ddiv">
      <pre *ngIf="!editText" class="bg-light p-3 border rounded mb-2">{{ textFilePreview }}</pre>

      <textarea *ngIf="editText" [(ngModel)]="textFilePreview" class="form-control mb-2" rows="10"></textarea>

      <div *ngIf="editText" class="d-flex justify-content-end">
        <button class="btn btn-secondary me-2" (click)="cancelEdit('text')">Cancel</button>
        <button class="btn btn-success" [disabled]="!isValidText(textFilePreview)" (click)="saveText()">Save</button>
      </div>
    </div>

    <button class="btn btn-primary mt-3" (click)="resetForm()">Reset</button>
  </div>
</div>